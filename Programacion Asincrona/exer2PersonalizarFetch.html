<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercicio 2 Personalizar Fetch</title>
    <style>
        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        body {
            width: 400px;
            margin: 10px auto;
            background-color: rgb(241, 241, 241);
            text-align: center;
        }

        form {
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 5px;

        }

        form>* {
            padding: 10px;
        }

        .tarefa {
            border: 1px solid black;
            margin: 10px;
            padding: 10px;
            text-align: left;
        }


        .completado {
            background-color: rgb(106, 172, 106);
        }

        .nocompletado {
            background-color: rgb(255, 155, 155);
        }
    </style>
</head>

<body>
    <h1>Xestion de tarefas</h1>
    <form id="form">
        <input type="text" id="textinput" placeholder="Introduce unha tarefa" />
        <input type="button" id="engadir" value="+ Engadir Tarefa" />
    </form>
    <script>
        const body = document.getElementsByTagName("body")[0]
        const boton = document.getElementById("engadir")
        const textinput = document.getElementById("textinput")
        const botonegadir = document.getElementById("engadir")

        let modoActualizar = false
        let divEditando = null

        function cargarTarefasIniciais() {
            fetch("https://jsonplaceholder.typicode.com/todos?_limit=10")
                .then(response => response.json())
                .then(data => {
                    crearTarefas(data)
                })
        }

        function crearTarefa(post) {
            const div = document.createElement("div")
            div.classList = "tarefa"
            div.dataset.id = post.id

            post.completed
                ? div.classList.add("completado")
                : div.classList.add("nocompletado")

            div.innerHTML = ` 
            <p><strong>Title: </strong><span class="titulo">${post.title}</span></p>
            <p><strong>Completed: </strong>${post.completed}</p>
            <p><strong>Post ID: </strong>${post.id}</p>
            <button class="actualizar">Actualizar</button>
            <button class="borrar">Eliminar</button>`

            body.appendChild(div)
        }

        function crearTarefas(posts) {
            posts.forEach(post => crearTarefa(post))
        }

        function actualizarTarefa(divEditando, nuevoTitulo) {
            const tituloSpan = divEditando.getElementsByClassName("titulo")[0]
            const id = divEditando.dataset.id

            fetch(`https://jsonplaceholder.typicode.com/posts/${id}`, {
                method: 'PATCH',
                body: JSON.stringify({ title: nuevoTitulo }),
                headers: { 'Content-type': 'application/json; charset=UTF-8' }
            })
                .then(response => {
                    if (response.ok) {
                        // Actualizamos DOM solo si la API responde bien
                        tituloSpan.innerHTML = nuevoTitulo

                        // Resetear estado global
                        modoActualizar = false
                        divEditando = null
                        botonegadir.value = "+ Engadir Tarefa"
                        textinput.value = ""
                    } else {
                        console.log("Error al actualizar")
                    }
                })
        }


        function apiCrearTarefa(titulo) {
            fetch('https://jsonplaceholder.typicode.com/posts', {
                method: 'POST',
                body: JSON.stringify({
                    userId: 1,
                    title: `${titulo}`,
                    completed: false,
                }),
                headers: {
                    'Content-type': 'application/json; charset=UTF-8'
                }
            })
                .then((response) => response.json())
                .then((json) => {
                    crearTarefa(json)
                })
        }

        boton.addEventListener("click", (e) => {
            e.preventDefault()

            if (modoActualizar && divEditando) {
                actualizarTarefa(divEditando, textinput.value)
                return
            }

            if (textinput.value) {
                apiCrearTarefa(textinput.value)
                textinput.value = ""
            }
        })



        body.addEventListener("click", (e) => {

            if (e.target.classList == "borrar") {

                //Evitas eliminar un tarea si estas en modo editar
                if (modoActualizar) return

                let div = e.target.closest("div")
                let id = div.dataset.id

                fetch(`https://jsonplaceholder.typicode.com/posts/${id}`, {
                    method: 'DELETE'
                }).then(response => {
                    if (response.ok) {
                        div.remove()
                    }
                })
            }

            if (e.target.classList == "actualizar") {
                let div = e.target.closest("div")
                let titulo = div.getElementsByClassName("titulo")[0]

                textinput.value = titulo.innerHTML
                botonegadir.value = "+ Actualizar Tarefa"

                modoActualizar = true
                divEditando = div
            }
        })

        cargarTarefasIniciais()


    </script>

</body>

</html>